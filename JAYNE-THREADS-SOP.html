<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cyril THREADS</title>
  <style>
     button, input, label {
      touch-action: manipulation;
    }   
    html, body {
      margin: 0;
      padding: 12px;
      font-family: 'Orbitron', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f1923; /* Valorant dark background */
      color: #ece8e1;      /* Light beige text */
      touch-action: manipulation;
    }

    /* Buttons */
    button {
      padding: 10px 16px;
      font-size: 16px;
      font-weight: bold;
      border: 2px solid #ff4655;  /* Valorant red */
      border-radius: 4px;
      background: #1f2329;
      color: #ece8e1;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      flex: 1 1 40%;
      margin: 5px;
      transition: 0.2s ease-in-out;
    }
    button:hover {
      background: #ff4655;
      color: #0f1923;
      box-shadow: 0 0 12px #ff4655;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Profile Box */
    #profileBox {
      background: #1b1f26;
      border: 2px solid #ff4655;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(255,70,85,0.3);
      padding: 16px;
      margin-bottom: 16px;
      color: black;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.75);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #0f1923;
      color: #ece8e1;
      padding: 20px;
      border-radius: 8px;
      border: 2px solid #ff4655;
      max-height: 80vh;
      overflow-y: auto;
      width: 95%;
      position: relative;
    }
    .modal-content h3 {
      color: #ff4655;
      text-transform: uppercase;
    }
    .modal-content button {
      background: #ff4655;
      color: #0f1923;
      border: none;
      font-size: 14px;
    }

    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
    }
    table th, table td {
      border: 1px solid #444;
      padding: 8px;
      font-size: 14px;
    }
    table th {
      background: #1f2329;
      color: #ff4655;
      text-transform: uppercase;
    }
    table tr:nth-child(even) {
      background: #161a1f;
    }

    /* Toast */
    #toast {
      visibility: hidden;
      min-width: 220px;
      background: #ff4655;
      color: #0f1923;
      font-weight: bold;
      text-align: center;
      border-radius: 6px;
      padding: 12px;
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;
    }
    #toast.show {
      visibility: visible;
      animation: fadein 0.3s, fadeout 0.5s 2s;
    }
    @keyframes fadein {
      from { bottom: 20px; opacity: 0; }
      to { bottom: 30px; opacity: 1; }
    }
    @keyframes fadeout {
      from { bottom: 30px; opacity: 1; }
      to { bottom: 20px; opacity: 0; }
    }

    /* Status checker */
    .status-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #statusBox {
      width: 22px;
      height: 22px;
      background-color: #0f1923;
      border: 2px solid #ff4655;
      border-radius: 4px;
    }
    #resultText {
      margin-top: 10px;
      font-weight: bold;
      color: #ff4655;
    }
  </style>
</head>
<body>
   <div id="buttonContainer" style="display:flex; flex-wrap:wrap; gap:4px; justify-content:center; margin-bottom:10px;">
    <button onclick="prevProfile()">‚¨ÖÔ∏è Prev</button>
    <button onclick="runNextContainer(); nextProfile()">Next ‚û°Ô∏è</button>
    <button onclick="GotoFirst(); goToFirstProfile()">üîÅ First </button>
    <button onclick="preloadSheets()">üîÑ Refresh</button>
  </div>
  
  <div id="profileBox" style="background:white; border-radius:16px; box-shadow:0 2px 6px rgba(0,0,0,0.08); padding:16px; margin-bottom:16px;">
  
  <div><strong>Username:</strong> <span id="username">-</span></div>
  <div><strong>Location:</strong> <span id="location">-</span></div>
  <div><strong>Container ID:</strong> <span id="container">-</span></div>
  <div><strong>Status:</strong> <span id="status">-</span></div>
</div>

  <div id="buttonContainer" style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-bottom:16px;">
    <button onclick="showModal('profileModal')">üìÑ Show Accounts</button>
    <button onclick="showModal('postsModal')">üìù Show Posts</button>
    <button onclick="pickRandom('Caption'); openThreads()">üñä Pick Caption</button>
    <button onclick="pickTodayPost()">üìÖ Pick Post</button>
    <button onclick="pickRandomTopicAndSearch()">üá∫üá∏ Topics</button>
    <button onclick="pickPicCap('Comments')">üñºÔ∏è Pic Caption</button>
    
  </div>
    <div class="status-wrapper">
      <button onclick="checkThreads()">Check Threads</button>
      <div id="statusBox" title="Status"></div>
    </div>
    <div id="resultText"></div>

  
  <div id="profileModal" class="modal">
    <div class="modal-content">
      <button onclick="hideModal('profileModal')" style="position:absolute; top:10px; left:10px; background:#ffdddd; border:none; border-radius:6px; padding:4px 10px;">‚ùå</button>
      <h3 style="margin-top:0;">üìÑ Accounts Sheet</h3>
      <table id="profileTable"></table>
    </div>
  </div>

  <div id="postsModal" class="modal">
    <div class="modal-content">
      <button onclick="hideModal('postsModal')" style="position:absolute; top:10px; left:10px; background:#ffdddd; border:none; border-radius:6px; padding:4px 10px;">‚ùå</button>
      <h3 style="margin-top:0;">üìù Posts Sheet</h3>
      <table id="postsTable"></table>
    </div>
  </div>

  <div>
    <h3>JAYNE THREADS PIC SOP</h3>
  </div>

  <div id="toast"></div>
  <script>
    function runNextContainer() {
    window.location.href = "shortcuts://run-shortcut?name=N%20THREADS";
  }
    function GotoFirst() {
    window.location.href = "shortcuts://run-shortcut?name=first";
  }

      
    const sheetUrl = 'https://script.google.com/macros/s/AKfycbzr1QtJMOfF-d7WWOwpYwBxLgHgzxXwQMkdYMiNRfvXrmduIIKEpWatmMMl8OKfiAr5/exec';
    let profiles = [], currentProfile = 0;
    let sheetCache = {}, pickedPostIndexes = {};

async function fetchSheet(sheetName) {
  if (sheetCache[sheetName]) return sheetCache[sheetName];
  const res = await fetch(`${sheetUrl}?sheet=${sheetName}`);
  if (!res.ok) throw new Error("Failed to fetch " + sheetName);
  const data = await res.json();
  sheetCache[sheetName] = data;
  return data;
}

async function preloadSheets() {
  try {
    setButtonsDisabled(true); // Lock buttons
    showToast("Refreshing data...");

    sheetCache = {}; // clear old data
    const savedIndex = parseInt(localStorage.getItem('lastProfileIndex')) || 0;

    profiles = await fetchSheet('Accounts');
    sheetCache['Accounts'] = profiles;
    sheetCache['Posts'] = await fetchSheet('Posts');
    sheetCache['Reply'] = await fetchSheet('Reply');
    sheetCache['Comments'] = await fetchSheet('Comments');
    sheetCache['Caption'] = await fetchSheet('Caption');

    showToast("Sheets refreshed!");
    displayProfile(savedIndex);
  } catch (e) {
    showToast("Refresh failed");
  } finally {
    setButtonsDisabled(false); // Unlock buttons
  }
}


function displayProfile(index) {
  if (profiles.length === 0) return;
  currentProfile = (index + profiles.length) % profiles.length;
  localStorage.setItem('lastProfileIndex', currentProfile); // Save to localStorage

  const profile = profiles[currentProfile];
  const box = document.getElementById('profileBox');

  document.getElementById('username').textContent = profile.username;
  document.getElementById('location').textContent = profile.location;
  document.getElementById('container').textContent = profile.container;
  document.getElementById('status').textContent = profile.status || "-";

  // Set background color based on status
  const status = (profile.status || "").toLowerCase();
  if (status === "active") {
    box.style.background = "#d4fcd4"; // light green
  } else if (status === "suspended") {
    box.style.background = "#ffd4d4"; // light red
  } else {
    box.style.background = "white"; // default
  }
}

function nextProfile() { displayProfile(currentProfile + 1); }
function prevProfile() { displayProfile(currentProfile - 1); }
function goToFirstProfile() { displayProfile(0); }

function showModal(id) {
  if (id === 'profileModal') loadAccounts();
  if (id === 'postsModal') loadPosts();
  document.getElementById(id).style.display = 'flex';
}
function hideModal(id) {
  document.getElementById(id).style.display = 'none';
}

async function loadAccounts() {
  try {
    const accounts = await fetchSheet('Accounts');
    const table = document.getElementById("profileTable");
    table.innerHTML = '<tr><th>Username</th><th>Location</th><th>Container ID</th></tr>' +
      accounts.map(p => `<tr><td>${p.username}</td><td>${p.location}</td><td>${p.container}</td></tr>`).join('');
  } catch (e) {
    showToast("Failed to load accounts");
  }
}

async function loadPosts() {
  try {
    const posts = await fetchSheet('Posts');
    const table = document.getElementById("postsTable");
    const days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
    table.innerHTML = '<tr>' + days.map(d => `<th>${d}</th>`).join('') + '</tr>' +
      posts.map(row => `<tr>` + days.map(day => `<td>${row[day] || ''}</td>`).join('') + '</tr>').join('');
  } catch (e) {
    showToast("Failed to load posts");
  }
}

function pickRandom(sheetName) {
  showToast(`Copying from ${sheetName}...`);
  fetchSheet(sheetName).then(data => {
    const choice = data[Math.floor(Math.random() * data.length)];
    let value = Object.values(choice)[0];

    // Replace (loc) with the current profile's location
    const loc = profiles[currentProfile]?.Location || profiles[currentProfile]?.location || "";
    value = value.replace(/\(loc\)/gi, loc);

    navigator.clipboard.writeText(value);
    showToast(`${sheetName} copied!`);
  }).catch(() => showToast(`Failed to load ${sheetName}`));
}

async function pickPicCap(sheetName) {
  try {
    showToast(`Loading from ${sheetName}...`);
    const data = await fetchSheet(sheetName);
    
    if (!data || data.length === 0) {
      showToast(`No data in ${sheetName}`);
      return;
    }
    
    const choice = data[Math.floor(Math.random() * data.length)];
    let value = Object.values(choice)[0];
    
    const location = profiles[currentProfile]?.location || profiles[currentProfile]?.Location || "";
    const finalText = value.replace(/\(loc\)/gi, location);
    
    lastPickedText = finalText;
    
    // Copy to clipboard first (so user can paste anywhere)
    await navigator.clipboard.writeText(finalText);
    
    // Then open Threads
    const encoded = encodeURIComponent(finalText);
    window.open(`https://www.threads.net/intent/post?text=${encoded}`, "_blank");
    
    showToast("Copied + Opening Threads!");
    
  } catch (error) {
    console.error(error);
    showToast(`Error: ${error.message}`);
  }
}

function resetPickedPosts() {
  pickedPostIndexes = {};
  showToast("Post pool reset!");
}

// USA TOPICS - Fixed & Integrated
  let hotTopics = [];

  async function fetchHotTopics() {
    if (hotTopics.length > 0) return; // Already loaded

    try {
      // Fetch from the 'Reply' sheet specifically
      const data = await fetchSheet('Reply'); // Using your existing fetchSheet function

      // Assuming your Topics sheet has a column like "topic" or the first value is the topic
      // Adjust the key if your column header is different (e.g., "hot_topic", "text", etc.)
      hotTopics = data
        .map(item => {
          // Try common possible keys, fallback to first value
          return (item.topic || item.hot_topic || item.text || item.reply || Object.values(item)[0])?.trim();
        })
        .filter(topic => topic && topic.length > 0);

      if (hotTopics.length === 0) {
        console.warn("No topics found in 'Topics' sheet. Using fallback.");
        hotTopics = ['Trump news', 'US economy', 'immigration policy', '2026 elections'];
      }
    } catch (error) {
      console.error('Error loading hot topics:', error);
      showToast("Failed to load USA topics");
      hotTopics = ['Trump news', 'US economy', 'breaking news'];
    }
  }

  async function pickRandomTopicAndSearch() {
    await fetchHotTopics();

    if (hotTopics.length === 0) {
      showToast("No topics available");
      return;
    }

    const randomTopic = hotTopics[Math.floor(Math.random() * hotTopics.length)];
    const query = encodeURIComponent(randomTopic);
    const threadsUrl = `https://www.threads.net/search?q=${query}`;

    window.open(threadsUrl, '_blank');
    showToast(`Searching: "${randomTopic}"`);
  }

//media attach shit
async function openThreadsMediaPicker() {
  try {
    showToast("Picking today's post...");
    const posts = await fetchSheet('Posts');
    const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    const today = days[new Date().getDay()];

    const todayPosts = posts
      .map((row, index) => ({ index, text: row[today] }))
      .filter(p => p.text?.trim());

    if (!pickedPostIndexes[today]) pickedPostIndexes[today] = [];
    const unused = todayPosts.filter(p => !pickedPostIndexes[today].includes(p.index));

    if (unused.length === 0) {
      pickedPostIndexes[today] = [];
      showToast("All posts used, restarting pool");
      return pickTodayPost();
    }

    const selected = unused[Math.floor(Math.random() * unused.length)];
    pickedPostIndexes[today].push(selected.index);

    const location = profiles[currentProfile]?.location || profiles[currentProfile]?.Location || "";
    const finalText = selected.text.replace(/\(loc\)/gi, location);

    await navigator.clipboard.writeText(finalText);
    showToast("Post copied with location!");
    window.open("https://www.threads.net/intent/post");
  } catch (e) {
    showToast("Error picking post");
  }
}

    
let lastPickedText = ""; //ito dagdag
async function pickTodayPost() {
  try {
    showToast("Picking today's post...");
    const posts = await fetchSheet('Posts');
    const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    const today = days[new Date().getDay()];

    const todayPosts = posts
      .map((row, index) => ({ index, text: row[today] }))
      .filter(p => p.text?.trim());

    if (!pickedPostIndexes[today]) pickedPostIndexes[today] = [];
    const unused = todayPosts.filter(p => !pickedPostIndexes[today].includes(p.index));

    if (unused.length === 0) {
      pickedPostIndexes[today] = [];
      showToast("All posts used, restarting pool");
      return pickTodayPost();
    }

    const selected = unused[Math.floor(Math.random() * unused.length)];
    pickedPostIndexes[today].push(selected.index);

    const location = profiles[currentProfile]?.location || profiles[currentProfile]?.Location || "";
    const finalText = selected.text.replace(/\(loc\)/gi, location);

    /*await navigator.clipboard.writeText(finalText);
    showToast("Post copied with location!");*/
    lastPickedText = finalText;
    const encoded = encodeURIComponent(finalText);
    window.open(`https://www.threads.net/intent/post?text=${encoded}`, "_blank");
    showToast("Opening Threads‚Ä¶");
  } catch (e) {
    showToast("Error picking post");
  }
}

function showToast(message) {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.className = "show";
  setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 2500);
}

function searchLocation() {
    const location = profiles[currentProfile]?.Location || profiles[currentProfile]?.location || '';
    if (!location) {
      showToast("Location not found for this profile.");
      return;
    }

    const query = encodeURIComponent(location);
    const url = `https://www.threads.net/search?q=${query}`;
    window.open(url, '_blank');
  }
    function openThreads() {
   window.open(`https://threads.com/`, "_blank");
}
    function setButtonsDisabled(disabled) {
  const buttons = document.querySelectorAll('#buttonContainer button');
  buttons.forEach(btn => btn.disabled = disabled);
}

    function checkThreads() {
    const box = document.getElementById("statusBox");
    const result = document.getElementById("resultText");

    // Reset to neutral
    box.style.backgroundColor = "white";
    result.textContent = "Checking...";

    // Use a lightweight HEAD request with CORS bypass
    fetch("https://www.threads.net", { mode: "no-cors" })
      .then(() => {
        box.style.backgroundColor = "green";
        result.textContent = "‚úÖ Threads is reachable.";
      })
      .catch(() => {
        box.style.backgroundColor = "red";
        result.textContent = "‚ùå Threads is not reachable (blocked or offline).";
      });
  }
    
window.onload = preloadSheets;// JavaScript will be attached separately to keep HTML clean.
  </script>
</body>
</html>
